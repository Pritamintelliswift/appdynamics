name: Install AppDynamics Machine Agent

on:
  push:
    branches:
      - master
#update
jobs:
  install-agent:
    runs-on: ubuntu-latest

    env:
      APPD_CONTROLLER_URL: ${{ secrets.APPD_CONTROLLER_URL }}
      APPD_USERNAME: ${{ secrets.APPD_USERNAME }}
      APPD_ACCESS_KEY: ${{ secrets.APPD_ACCESS_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GCP_KEY_JSON: ${{ secrets.GCP_KEY_JSON }}
      EC2_PEM: ${{ secrets.EC2_PEM }}
      EC2_USER: ubuntu
      EC2_HOST: ${{ secrets.EC2_HOST }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PEM }}" > ~/.ssh/appdynamics.pem
          chmod 600 ~/.ssh/appdynamics.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg unzip

      - name: Install Google Cloud SDK
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update && sudo apt-get install -y google-cloud-sdk

      - name: Authenticate GCP Service Account
        run: |
          echo "${{ secrets.GCP_KEY_JSON }}" | base64 --decode > /tmp/gcp.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp.json
          gcloud auth activate-service-account --key-file=/tmp/gcp.json
          gcloud auth list

      - name: Download AppDynamics Machine Agent
        run: |
          gsutil -m cp gs://appdynamics-agent/machineagent-bundle-64bit-linux-25.7.0.4825.zip /tmp/machineagent.zip

      - name: Install Ansible on EC2 and Copy Files
        run: |
          ssh -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            sudo apt-get update
            sudo apt-get install -y ansible unzip
            mkdir -p ~/playbooks ~/inventory
          EOF

          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -r ./playbooks ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/playbooks
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -r ./inventory ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/inventory
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no /tmp/machineagent.zip ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/machineagent.zip

      - name: Run Ansible Playbook on EC2
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          ssh -i ~/.ssh/appdynamics.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ~/inventory/hosts.ini ~/playbooks/install_machine_agent.yml \
            --extra-vars 'appd_controller_url=${{ env.APPD_CONTROLLER_URL }} appd_username=${{ env.APPD_USERNAME }} appd_access_key=${{ env.APPD_ACCESS_KEY }} machine_agent_file=~/machineagent.zip gcp_key_file=/tmp/gcp.json'"
