name: Install AppDynamics Machine Agent

on:
  workflow_dispatch:  # allows manual trigger

jobs:
  install-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up GCP service account key
        run: |
          echo "${{ secrets.GCP_KEY_JSON }}" > /tmp/gcp.json
          chmod 600 /tmp/gcp.json
        shell: bash

      - name: Install Google Cloud SDK
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates gnupg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install -y google-cloud-sdk
        shell: bash

      - name: Download Machine Agent from GCS
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp.json
          gsutil -m cp gs://appdynamics-agent/machineagent-bundle-64bit-linux-25.7.0.4825.zip /tmp/
        shell: bash

      - name: Optional - Run Ansible Playbook
        uses: appleboy/ansible-action@v0.4.0
        with:
          playbook: playbooks/install_machine_agent.yml
          inventory: inventory/hosts.ini
          extra_vars: |
            appd_controller_url=https://****.saas.appdynamics.com
            appd_username=****
            appd_access_key=****
            gcp_key_file=/tmp/gcp.json
