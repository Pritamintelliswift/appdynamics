name: Install AppDynamics Machine Agent

on:
  push:
    branches:
      - master

jobs:
  install-agent:
    runs-on: ubuntu-latest

    env:
      APPD_CONTROLLER_URL: ${{ secrets.APPD_CONTROLLER_URL }}
      APPD_USERNAME: ${{ secrets.APPD_USERNAME }}
      APPD_ACCESS_KEY: ${{ secrets.APPD_ACCESS_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GCP_KEY_JSON_BASE64: ${{ secrets.GCP_KEY_JSON_BASE64 }}
      EC2_PEM: ${{ secrets.EC2_PEM }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_HOST: ${{ secrets.EC2_HOST }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.EC2_PEM }}" > ~/.ssh/appdynamics.pem
          chmod 600 ~/.ssh/appdynamics.pem
          # Disable strict host key checking
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg unzip

      - name: Install Google Cloud SDK
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update && sudo apt-get install -y google-cloud-sdk

      - name: Authenticate GCP Service Account
        run: |
          echo "${{ secrets.GCP_KEY_JSON }}" | base64 --decode > /tmp/gcp.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp.json
          gcloud auth activate-service-account --key-file=/tmp/gcp.json
          gcloud auth list

      - name: Download AppDynamics Machine Agent
        run: |
          gsutil -m cp gs://appdynamics-agent/machineagent-bundle-64bit-linux-25.7.0.4825.zip /tmp/machineagent.zip

      - name: Install Ansible on EC2 and Copy Files
        run: |
          ssh -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${{ env.EC2_HOST }} << 'EOF'
            sudo apt-get update
            sudo apt-get install -y ansible unzip
            mkdir -p ~/playbooks ~/inventory
          EOF

          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./playbooks ubuntu@${{ env.EC2_HOST }}:~/playbooks
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./inventory ubuntu@${{ env.EC2_HOST }}:~/inventory
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/machineagent.zip ubuntu@${{ env.EC2_HOST }}:~/machineagent.zip

      - name: Run Ansible Playbook on EC2
        run: |
          ssh -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${{ env.EC2_HOST }} \
          "ansible-playbook -i ~/inventory/hosts.ini ~/playbooks/install_machine_agent.yml \
            --extra-vars 'appd_controller_url=${{ env.APPD_CONTROLLER_URL }} \
            appd_username=${{ env.APPD_USERNAME }} \
            appd_access_key=${{ env.APPD_ACCESS_KEY }} \
            machine_agent_file=~/machineagent.zip \
            gcp_key_file=/tmp/gcp.json \
            ec2_host=${{ env.EC2_HOST }}'"
