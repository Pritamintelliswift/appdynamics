name: Install AppDynamics Machine Agent

on:
  push:
    branches:
      - master

jobs:
  install-agent:
    runs-on: ubuntu-latest

    env:
      APPD_CONTROLLER_URL: ${{ secrets.APPD_CONTROLLER_URL }}
      APPD_USERNAME: ${{ secrets.APPD_USERNAME }}
      APPD_ACCESS_KEY: ${{ secrets.APPD_ACCESS_KEY }}
      EC2_PEM: ${{ secrets.EC2_PEM }}
      EC2_USER: ubuntu
      EC2_HOST: ${{ secrets.EC2_HOST }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PEM }}" > ~/.ssh/appdynamics.pem
          chmod 400 ~/.ssh/appdynamics.pem

      - name: Download AppDynamics Machine Agent
        run: |
          curl -L -o /tmp/machineagent.zip "https://download.appdynamics.com/path/to/machineagent-bundle-64bit-linux.zip"
          ls -lh /tmp/machineagent.zip

      - name: Install Ansible on EC2
        run: |
          ssh -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            sudo apt-get update
            sudo apt-get install -y ansible unzip
            mkdir -p ~/playbooks ~/inventory
          EOF

      - name: Copy Playbook, Inventory, and Agent to EC2
        run: |
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no ./playbooks/install_machine_agent.yml ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/playbooks/
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no ./inventory/hosts.ini ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/inventory/
          scp -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no /tmp/machineagent.zip ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/machineagent.zip

      - name: Verify Files on EC2
        run: |
          ssh -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "ls -l ~/playbooks ~/inventory ~/machineagent.zip"

      - name: Run Ansible Playbook on EC2
        run: |
          ssh -i ~/.ssh/appdynamics.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << EOF
            export ANSIBLE_HOST_KEY_CHECKING=False
            ansible-playbook -i ~/inventory/hosts.ini ~/playbooks/install_machine_agent.yml \
              --extra-vars "appd_controller_url=${APPD_CONTROLLER_URL} appd_username=${APPD_USERNAME} appd_access_key=${APPD_ACCESS_KEY} machine_agent_file=~/machineagent.zip"
          EOF
